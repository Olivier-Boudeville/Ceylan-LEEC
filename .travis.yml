sudo: required
dist: trusty

language: erlang

otp_release:
    - 18.2.1
    - 17.5

#env:
#    - BOULDER_BUILD=https://acme-v01.api.letsencrypt.org/build

services:
    - rabbitmq
    - mariadb

addons:
    apt:
        packages:
            - elinks
            - rsyslog

    mariadb: "10.0"

    hosts:
        - le.wtf
        - le2.wtf
        - boulder-mysql
        - boulder-rabbitmq

env:
    global:
        - GOPATH=/tmp/go
        - PATH=$GOPATH/bin:$PATH
    matrix:
        - BOULDER_BUILD=https://acme-v01.api.letsencrypt.org/build
        #- BOULDER_BUILD=https://acme-staging.api.letsencrypt.org/build

# we only test boulder staging version against last OTP version
matrix:
    include:
        - otp_release: 18.2.1
          env: BOULDER_BUILD=https://acme-staging.api.letsencrypt.org/build


before_install:
    # small files webservers
    - git clone --depth=1 https://github.com/jeanparpaillon/averell.git averell
    - cd averell && make && make
    - cd $TRAVIS_BUILD_DIR
    # letsencrypt server
    - go version
    - git clone https://github.com/letsencrypt/boulder.git $GOPATH/src/github.com/letsencrypt/boulder
    - cd $GOPATH/src/github.com/letsencrypt/boulder
    #- go get github.com/tools/godep
    #- godep restore -v
    # we want to test agains version running on prod
    #- BOULDER_BUILD=https://acme-v01.api.letsencrypt.org/build
    - REV=`elinks -dump $BOULDER_BUILD|sed -e "s/.*Boulder=( +\([0-9a-f]\+\) .*/\1/"`
    - echo "using boulder rev +$REV"
    - git checkout $REV
    - test/setup.sh
    - go get github.com/jsha/listenbuddy
    #- ls $GOPATH/bin $GOPATH/pkg/*/* $GOPATH/src/*
    - cd $TRAVIS_BUILD_DIR

install:
    - ./rebar3 update
    - ./rebar3 compile

before_script:
    # serve CA certificate
    - averell/averell -p 3099 -v $GOPATH/src/github.com/letsencrypt/boulder&
    #
    - cd $GOPATH/src/github.com/letsencrypt/boulder
    # prevent limiting certificates generation
    - "sed -i 's/threshold: 5/threshold: 100/' test/rate-limit-policies.yml"
    #- cat test/rate-limit-policies.yml
    - ./start.py > /tmp/boulder.log&
    - cd $TRAVIS_BUILD_DIR
    # waiting for boulder being fully started
    - r=1; while [ $r -ne 0 ] ; do elinks -dump http://localhost:4000/directory 2>/dev/null; r=$?; sleep 5; done


script: 
    - make dialize
    #- http GET http://127.0.0.1:3099/test/test-ca.pem
    - ./rebar3 ct

after_failure:
    - elinks -dump 1 _build/test/logs/ct_run.*/_build.test.logs/run.*/suite.log.html
    - elinks -dump 1 _build/test/logs/ct_run.*/_build.test.logs/run.*/letsencrypt_suite.test_*
    - elinks -dump 1 _build/test/logs/ct_run.*/_build.test.logs/run.*/unexpected_io.log.html
    - cat /tmp/boulder.log
