sudo: required

language: erlang

otp_release:
    - 18.2.1
    - 17.5

addons:
    apt:
        packages:
            - httpie
            - elinks

services:
    - docker

before_install:
    # small files webservers
    - git clone --depth=1 https://github.com/jeanparpaillon/averell.git averell
    - cd averell && make && make
    - cd $TRAVIS_BUILD_DIR
    # letsencrypt server
    - git clone --depth=1 https://github.com/letsencrypt/boulder.git boulder
    - cd boulder && docker-compose build
    - cd $TRAVIS_BUILD_DIR

install:
    - ./rebar3 update
    - ./rebar3 compile

before_script:
    # serve CA certificate
    - averell/averell -p 3099 -v boulder&
    #
    - sed -i 's/-it/-i/' boulder/test/run-docker.sh
    - boulder/test/run-docker.sh&
    # waiting for boulder being fully started
    - r=1; while [ $r -ne 0 ] ; do http http://localhost:4000/directory 2>/dev/null; r=$?; sleep 5; done


script: 
    - make dialize
    #- http GET http://127.0.0.1:3099/test/test-ca.pem
    - ./rebar3 ct

after_failure:
    - elinks -dump 1 _build/test/logs/ct_run.*/_build.test.logs/run.*/suite.log.html
    - elinks -dump 1 _build/test/logs/ct_run.*/_build.test.logs/run.*/letsencrypt_suite.test_*
