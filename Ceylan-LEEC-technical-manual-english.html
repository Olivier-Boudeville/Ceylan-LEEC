<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />
<title>Welcome to the Ceylan-LEEC documentation</title>
<meta content="LEEC, X509, certificate, SSL, https, Erlang" name="keywords" />
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="leec.css" type="text/css" />
<link href="leec-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document">


<span class="target" id="top"></span><p><span class="raw-html"><a name="leec_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>LEEC documentation</em> <a href="http://leec.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/Ceylan-LEEC">browse mirror</a> <a href="Ceylan-LEEC-technical-manual-english.pdf">get PDF</a> <a href="#leec_top">go to top</a> <a href="#leec_toc">go to toc</a> <a href="#leec_bottom">go to bottom</a> <a href="api-doc/index.html">browse API</a> <a href="https://github.com/Olivier-Boudeville/Ceylan-LEEC">go to project</a> <a href="mailto:about(dash)leec(at)esperide(dot)com?subject=[Ceylan-LEEC]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="leec-title.png" id="responsive-image-small"></img></center></span>
</p>
<div class="section" id="technical-manual-of-leec-let-s-encrypt-erlang-with-ceylan">
<h1><a class="toc-backref" href="#id16">Technical Manual of LEEC: <em>Let's Encrypt Erlang with Ceylan</em></a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body">Copyright (C) 2020-2021 Olivier Boudeville</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body">about (dash) leec (at) esperide (dot) com</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body">Wednesday, November 11, 2020</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Wednesday, June 16, 2021</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">1.1.1</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Stable</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Saturday, May 22, 2021</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body">Users and maintainers of the <tt class="docutils literal">LEEC</tt> library</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body">The role of the <tt class="docutils literal">LEEC</tt> library is to interact from Erlang/OTP with servers implementing the ACME protocol - specifically <em>Let's Encrypt</em> servers, mostly in order to generate X.509 certificates.</td>
</tr>
</tbody>
</table>
<p>The latest version of this documentation is to be found at the <a class="reference external" href="http://leec.esperide.org">official LEEC website</a> (<tt class="docutils literal"><span class="pre">http://leec.esperide.org</span></tt>).</p>
<p><span class="raw-html">This LEEC documentation is also available in the PDF format (see <a href="Ceylan-LEEC-technical-manual-english.pdf">Ceylan-LEEC-technical-manual-english.pdf</a>), and mirrored <a href="http://olivier-boudeville.github.io/Ceylan-LEEC/">here</a>.</span></p>
<p></p>
<p></p>
<p><span class="raw-html"><a name="leec_toc"></a></span></p>
<div class="contents topic" id="id1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#technical-manual-of-leec-let-s-encrypt-erlang-with-ceylan" id="id16">Technical Manual of LEEC: <em>Let's Encrypt Erlang with Ceylan</em></a><ul>
<li><a class="reference internal" href="#overview" id="id17">Overview</a></li>
<li><a class="reference internal" href="#differences-introduced-by-this-fork" id="id18">Differences Introduced by this Fork</a></li>
<li><a class="reference internal" href="#prerequisites" id="id19">Prerequisites</a><ul>
<li><a class="reference internal" href="#dependency-basics" id="id20">Dependency Basics</a></li>
<li><a class="reference internal" href="#switching-json-parsers" id="id21">Switching JSON Parsers</a></li>
<li><a class="reference internal" href="#dependency-issues-between-webservers-and-http-s-clients" id="id22">Dependency Issues between Webservers and HTTP(s) Clients</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building" id="id23">Building</a></li>
<li><a class="reference internal" href="#usage-example" id="id24">Usage Example</a></li>
<li><a class="reference internal" href="#design-notes" id="id25">Design Notes</a><ul>
<li><a class="reference internal" href="#multiple-domains-having-each-multiple-hostnames" id="id26">Multiple Domains Having Each Multiple Hostnames</a></li>
<li><a class="reference internal" href="#concurrent-certificate-operations" id="id27">Concurrent Certificate Operations</a></li>
<li><a class="reference internal" href="#let-s-encrypt-accounts" id="id28">Let's Encrypt Accounts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-information-about-the-generated-certificates" id="id29">Getting Information about the Generated Certificates</a></li>
<li><a class="reference internal" href="#other-files-of-interest" id="id30">Other Files of Interest</a></li>
<li><a class="reference internal" href="#troubleshooting-https-certificate-related-issues" id="id31">Troubleshooting HTTPS Certificate-related Issues</a></li>
<li><a class="reference internal" href="#licence" id="id32">Licence</a></li>
<li><a class="reference internal" href="#support" id="id33">Support</a></li>
<li><a class="reference internal" href="#possible-enhancements" id="id34">Possible Enhancements</a></li>
<li><a class="reference internal" href="#please-react" id="id35">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="id36">Ending Word</a></li>
</ul>
</li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id17">Overview</a></h2>
<p>The LEEC library is the Ceylan fork of the original and much appreciated <a class="reference external" href="https://github.com/gbour/letsencrypt-erlang">letsencrypt-erlang</a>, which is a <a class="reference external" href="https://letsencrypt.org/">Let's Encrypt</a> client library for Erlang whose author is Guillaume Bour.</p>
<p>LEEC's purpose is to obtain proper X.509 security certificates from <tt class="docutils literal">Let's Encrypt</tt> - or more generally <a class="reference external" href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment">ACME servers</a> (version 2), typically in order to secure one's webservers so that they can offer a solid HTTPS connectivity, which is pretty much standard nowadays.</p>
<p>LEEC is notably used in the context of <a class="reference external" href="http://us-web.esperide.org/">US-Web</a>.</p>
</div>
<div class="section" id="differences-introduced-by-this-fork">
<h2><a class="toc-backref" href="#id18">Differences Introduced by this Fork</a></h2>
<p>Compared to the original <tt class="docutils literal"><span class="pre">letsencrypt-erlang</span></tt> library, the main differences introduced by LEEC are:</p>
<ul class="simple">
<li>it is more specialised, in the sense that LEEC focuses on the &quot;slave&quot; use case (i.e. to be directly integrated within an Erlang webserver), as opposed to the &quot;webroot&quot; one (a third-party webserver is running separately with little possibilities of direct interactions) or the &quot;standalone&quot; one (where no specific prior webserver would be running, the certificate agent operating then its own one)</li>
<li>more comments, more spell-checking, much clarification</li>
<li>more typing, more runtime checking, extended traces supported</li>
<li>security increased (notably using 4096-bit RSA keys)</li>
<li>dependency onto <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceylan-Myriad</a> added, to benefit from its facilities</li>
<li>JSON parser can be JSX (the default), or Jiffy (refer to the <tt class="docutils literal">JSON parsers</tt> section)</li>
<li>HTTP client can be either <tt class="docutils literal">Shotgun</tt> or the Erlang-native <tt class="docutils literal">httpc</tt> client, to avoid any extra dependencies on <tt class="docutils literal">Gun</tt> and <tt class="docutils literal">Cowlib</tt> (whose versions could potentially clash with the ones required by any <tt class="docutils literal">Cowboy</tt>-based integrating webserver)</li>
<li>porting done from <a class="reference external" href="https://erlang.org/documentation/doc-6.1/lib/stdlib-2.1/doc/html/gen_fsm.html">gen_fsm</a> (soon to be deprecated) to the newer <a class="reference external" href="https://erlang.org/doc/man/gen_statem.html">gen_statem</a></li>
<li>minor API changes and additions, for a clearer and more flexible mode of operation</li>
<li>fixed the compilation with Erlang version 24.0 and higher (ex: w.r.t. to <tt class="docutils literal">http_uri</tt>/<tt class="docutils literal">uri_string</tt>, to updated dependencies such as Jiffy, and newer Cowboy for the examples)</li>
<li>allow for <em>concurrent</em> certificate requests (ex: if managing multiple domains with different keys, new certificates being requested for all of them at webserver start-up); so LEEC generates certificates in parallel and does not rely on a <em>registered</em> FSM (<em>Finite State Machine</em>) anymore</li>
<li>global, ETS-based TCP connection pool replaced by an (optional) per-FSM internal cache (if relying on Shotgun)</li>
<li>support for SAN (<a class="reference external" href="https://en.wikipedia.org/wiki/Subject_Alternative_Name">Subject Alternative Name</a>) certificates, an extension to X.509 enabling a certificate to include a <tt class="docutils literal">subjectAltName</tt> field to list, here, extra DNS names that are covered by this certificate</li>
<li>basic support for the management of:<ul>
<li><em>Ephemeral Diffie-Helman</em> key, to ensure <em>Forward Secrecy</em> by relying on a set of keys that are never communicated</li>
<li><a class="reference external" href="https://letsencrypt.org/certificates/">Intermediate Let's Encrypt Certificates</a></li>
</ul>
</li>
</ul>
<p>So, even if LEEC can be seen mostly as a &quot;reckless&quot; fork (in the sense that it became quickly obvious that retaining upstream compatibility could hardly be achieved) - with so many source-level differences (in terms of conventions, Myriad integration, whitespace cleanup) that a pull request can difficultly be considered - yet, in spite of the appearances, it remained quite close to the original (mainly differences of form) and followed the same structure.</p>
<p>By some ways, this LEEC fork is safer and more robust than the original, by others not (ex: test coverage, autonomous use, continuous integration). A key goal was to make it easier to understand and maintain.</p>
<p>Most of the elements of <a class="reference external" href="https://github.com/gbour/letsencrypt-erlang/pull/16/">this pull request</a> from Marc Worrell have also been integrated.</p>
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id19">Prerequisites</a></h2>
<div class="section" id="dependency-basics">
<h3><a class="toc-backref" href="#id20">Dependency Basics</a></h3>
<p>The general dependencies are:</p>
<ul class="simple">
<li><tt class="docutils literal">openssl</tt>, version  1.1.1 or higher (required to generate RSA key and certificate request)</li>
<li><tt class="docutils literal">Erlang/OTP</tt> (refer to the <a class="reference external" href="http://myriad.esperide.org#prerequisites">Myriad prerequisite section</a>  section for the supported versions)</li>
</ul>
<p>The LEEC-specific ones, which are automatically managed by rebar3 if opting for a rebar-based build, are:</p>
<ul class="simple">
<li>a JSON parser: either <a class="reference external" href="https://github.com/talentdeficit/jsx">jsx</a> (the default) or <a class="reference external" href="https://github.com/davisp/jiffy">jiffy</a></li>
<li><a class="reference external" href="http://myriad.esperide.org/">Ceylan-Myriad</a>, for the various facilities on which LEEC relies</li>
<li>optional: a more advanced HTTP client than the <a class="reference external" href="https://erlang.org/doc/man/httpc.html">httpc</a> Erlang-native one, namely <a class="reference external" href="https://github.com/inaka/shotgun">Shotgun</a>, which should be more efficient (TCP connection re-used, recent HTTP, etc.) at the cost of an extra dependency (which may clash with any your application may introduce, refer to the <a class="reference internal" href="#dependency-issues">dependency issues</a> section)</li>
</ul>
</div>
<div class="section" id="switching-json-parsers">
<h3><a class="toc-backref" href="#id21">Switching JSON Parsers</a></h3>
<p>If wanting to switch from the default <a class="reference external" href="https://github.com/talentdeficit/jsx">jsx</a> to <a class="reference external" href="https://github.com/davisp/jiffy">jiffy</a>, following files shall be updated:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/letsencrypt-erlang/blob/master/rebar.config">rebar.config</a> (knowing it is generated from <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/blob/master/conf/leec.app.src">conf/leec.app.src</a>)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/blob/master/src/leec.app.src">src/leec.app.src</a> (knowing it is a mere symlink to <tt class="docutils literal">ebin/leec.app</tt>, which is itself generated from  <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/blob/master/conf/leec.app.src">conf/leec.app.src</a>)</li>
</ul>
<p>(none in Myriad)</p>
</div>
<div class="section" id="dependency-issues-between-webservers-and-http-s-clients">
<span id="dependency-issues"></span><h3><a class="toc-backref" href="#id22">Dependency Issues between Webservers and HTTP(s) Clients</a></h3>
<p>A potential dependency problem is that many Erlang-based webservers are powered by Cowboy (thus Cowlib) whereas LEEC used to rely necessarily on Shotgun, thus on Gun (and thus Cowlib) as well. Most of the time this implied different (potentially incompatible) versions of Cowlib, whereas only up to one should exist in the code path at any time.</p>
<p>We prefer sticking to the Cowlib version that is induced by Cowboy. At the time of this writing, the latest Cowboy stable version (the one that webserver projects such as <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/">US-Web</a> want) is 2.8.0 and relies on Cowlib 2.9.1, whereas the latest Shotgun stable version, 0.5.0, is lagging behind, relying on Gun 1.3.1, itself relying on Cowlib 2.6.0 (too old).</p>
<p>An attempt of solution was to remove the dependency of LEEC onto Shotgun (as it induced a dependency on an older Cowlib) but to use Gun instead, which is lower-level yet might be chosen in order to rely on the target Cowlib version. However we did not found a suitable Gun version for that (1.3 being too old, 2.0.* not ready).</p>
<p>So a last-resort solution has been to rely instead on the even lower-level Erlang-native <a class="reference external" href="https://erlang.org/doc/man/httpc.html">httpc</a> client module (involving <tt class="docutils literal">inets</tt> and <tt class="docutils literal">ssl</tt>). The result, although based only on HTTP/1.1 with no connection-reuse, proved satisfactory right from the start and thus is provided as an alternate way of using LEEC, without involving any extra dependency.</p>
<p>This allows embedding LEEC with only one dependency onto Myriad and one onto a JSON parser (either jsx or jiffy) - and no other one (top-level or induced).</p>
</div>
</div>
<div class="section" id="building">
<h2><a class="toc-backref" href="#id23">Building</a></h2>
<p>Two build procedures can be used (from the root of LEEC), and are now mostly the same:.</p>
<ul class="simple">
<li>either a rebar3-based one; then run <tt class="docutils literal">make <span class="pre">all-rebar3</span></tt>, simply corresponding to:</li>
</ul>
<pre class="code bash literal-block">
$ rebar3 upgrade
$ rebar3 compile
</pre>
<ul class="simple">
<li>or one relying on Ceylan's native build system; once the relevant prerequisites have been setup (selected, downloaded, built), just run <tt class="docutils literal">make all</tt></li>
</ul>
<p>This last procedure is the one that we prefer and use routinely (see the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/priv/bin/deploy-us-web-native-build.sh">US-Web native deployment script</a> as an example thereof).</p>
</div>
<div class="section" id="usage-example">
<h2><a class="toc-backref" href="#id24">Usage Example</a></h2>
<p>The main example of LEEC in action can be found in link with <a class="reference external" href="https://us-web.esperide.org/">US-Web</a>, whose sources can be found <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/src">here</a>; see notably <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USCertificateManager.erl">class_USCertificateManager.erl</a> and <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_letsencrypt_handler.erl">us_web_letsencrypt_handler.erl</a>.</p>
<p>This mode of operation, described <a class="reference external" href="https://us-web.esperide.org/#managing-public-key-certificates">in this section</a>, is typical of the use case where an Erlang-based webserver (in this case based on <a class="reference external" href="https://github.com/ninenines/cowboy">Cowboy</a>) has to renew certificates corresponding to the various virtual hosts (possibly dispatched under various domains) that it is making available.</p>
<p>A first part is to create as many LEEC FSMs as domains of interest, which will connect to the target ACME servers (most probably Let's Encrypt ones). Each FSM is a LEEC agent that will generate its own (strong) RSA key, create automatically its throwaway ACME account on the server, secure properly the communication (with TLS signatures, nonces, etc.), and wait for further user request regarding its domain of interest (ex: <tt class="docutils literal">foobar.org</tt>).</p>
<p>Such a request is bound to ask the ACME server to generate (as a Certificate Authority) a X.509 certificate covering, thanks to SAN, a set of subdomains (FQDN) to secure (ex: <tt class="docutils literal">hello.foobar.org</tt>, <tt class="docutils literal">hurricane.foobar.org</tt>) - knowing that no wildcard certificate can be obtained with the <tt class="docutils literal"><span class="pre">http-01</span></tt> challenge being used here. The ACME server will send challenges to LEEC so that it can prove that it controls indeed all these subdomains.</p>
<p>A second part of the LEEC action is to ensure that these answers are available indeed, as tokens. In practice the ACME server will attempt to read them at specific URLs (prefixed with <tt class="docutils literal"><span class="pre">.well-known/acme-challenge/</span></tt>) expected to be served for these subdomains (most probably thanks to virtual hosting). If the ACME server is able to query and read, directly from a domain, the right tokens corresponding to the challenges it sent for this domain, then the proof of actual control by the requester is established, and the ACME server can thus issue a corresponding certificate and transmit it appropriately to LEEC.</p>
<p>The overall webserver of the user shall thus track the transitions of these FSMs until (hopefully) they successfully complete their procedure and obtain from their ACME server the corresponding certificate. Then only the user webserver will be able to fire its https support with these brand new certificates <a class="footnote-reference" href="#id10" id="id9">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[1]</a></td><td>Before, even if suitable certificates were pre-existing, at least the ACME URL prefix was to remain over http instead of being automatically promoted to https as all others.</td></tr>
</tbody>
</table>
<p>Finally, a task scheduler may be used to trigger renewals on time (not too soon, not too late, as ACME rules apply and, of course, each FQDN shall be covered by a valid certificate at any time), and a task ring may be used to (paradoxically) ensure that the webserver as a whole does not interact too much in parallel (through its various LEEC FSMs) with the ACME server (despite hosting potentially a large number of FQDNs), knowing that severe rate limits (example in <a class="reference external" href="https://letsencrypt.org/docs/rate-limits/">production</a>) apply.</p>
<p>LEEC does its best to go through this procedure, validating as much as possible each of these steps for a better reliability/control, and reporting outcome for tracability and error management.</p>
<p>In practice, the user code is expected:</p>
<ol class="upperalpha simple">
<li>to initialise first LEEC, with <tt class="docutils literal"><span class="pre">leec:start/{1,2}</span></tt> and proper options (see <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/blob/master/src/leec.erl">leec.erl</a>); the PID of the corresponding LEEC FSM is then returned</li>
<li>to request, thanks to this PID, a certificate to be generated for a domain, with <tt class="docutils literal"><span class="pre">leec:obtain_certificate_for/{2,3}</span></tt></li>
<li>to answer properly to the corresponding challenges for each (sub)domain, by delivering the right LEEC-computed tokens; see <tt class="docutils literal">leec:send_ongoing_challenges/2</tt></li>
<li>to poll this FSM to establish if/when the targeted certificate is available; actually it is more convenient to define in (2) a callback to be triggered by LEEC when appropriate</li>
</ol>
<p>For US-Web, (1), (2) and (4) are managed by <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/class_USCertificateManager.erl">class_USCertificateManager.erl</a> (see respectively <tt class="docutils literal">init_leec/5</tt>, <tt class="docutils literal">request_certificate/1</tt> and the <tt class="docutils literal">onCertificateRequestOutcome/2</tt> callback). (3) is taken in charge by <a class="reference external" href="https://github.com/Olivier-Boudeville/us-web/blob/master/src/us_web_letsencrypt_handler.erl">us_web_letsencrypt_handler.erl</a> (see <tt class="docutils literal">init/2</tt>).</p>
</div>
<div class="section" id="design-notes">
<h2><a class="toc-backref" href="#id25">Design Notes</a></h2>
<div class="section" id="multiple-domains-having-each-multiple-hostnames">
<h3><a class="toc-backref" href="#id26">Multiple Domains Having Each Multiple Hostnames</a></h3>
<p>At least the ACME servers from Let's Encrypt enforce various rate limits (both in <a class="reference external" href="https://letsencrypt.org/docs/rate-limits/">production environment</a> and in <a class="reference external" href="https://letsencrypt.org/docs/staging-environment/">staging</a> one) that are fairly low, which leads to preferring requesting certificates only on a per-domain basis (ex: globally for <tt class="docutils literal">foobar.org</tt>) rather than on a per-hostname host basis (ex: one for <tt class="docutils literal">baz.foobar.org</tt>, another one for <tt class="docutils literal">hurrican.foobar.org</tt>, etc., these hosts being virtual ones or not), as such requests would quickly become too numerous to respect these rate thresholds.</p>
<p>A per-domain certificate should then include directly its various hostnames as <em>Subject Alternative Names</em> (SAN entries).</p>
<p>With the <tt class="docutils literal"><span class="pre">http-01</span></tt> challenge type, no wildcard for such SAN hosts (ex: <tt class="docutils literal">*.foobar.org</tt>) can be specified, so all the wanted ones have to be explicitly listed <a class="footnote-reference" href="#id14" id="id13">[2]</a>.</p>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id13">[2]</a></td><td>As a result, the certificate may disclose virtual hosts that would be otherwise invisible from the Internet (as not even declared in the DNS entries for that domain that would act as wildcard name resolvers).</td></tr>
</tbody>
</table>
<p>So for example, with LEEC, the certificate for <tt class="docutils literal">foobar.org</tt> (that would be managed by a dedicated LEEC agent) should list following SAN entries: <tt class="docutils literal">baz.foobar.org</tt>, <tt class="docutils literal">hurrican.foobar.org</tt>, etc.</p>
</div>
<div class="section" id="concurrent-certificate-operations">
<h3><a class="toc-backref" href="#id27">Concurrent Certificate Operations</a></h3>
<p>LEEC implemented independent (<tt class="docutils literal">gen_statem</tt>) FSMs to allow typically for concurrent certificate renewals to be triggered (thanks to autonomous LEEC agents, per-FSM connection pools, separate keys, etc.).</p>
<p>A drawback of the aforementioned Let's Encrypt rate limits is that, while a given FSM is to remain below said thresholds, a set of parallel ones may not.</p>
<p>Should this issue arise, an option is to use a single FSM and to trigger certificate requests in turn. Another one is to rely on a <a class="reference external" href="https://olivier-boudeville.github.io/us-common/#facilities-provided-by-this-layer">task ring</a> in order to avoid by design that such FSMs overlap.</p>
</div>
<div class="section" id="let-s-encrypt-accounts">
<span id="caa"></span><h3><a class="toc-backref" href="#id28">Let's Encrypt Accounts</a></h3>
<p>Currently LEEC creates automatically throwaway ACME accounts, which is convenient yet may prevent the use if <a class="reference external" href="https://letsencrypt.org/docs/caa/">CAA</a> (<em>Certificate Authority Authorization</em>).</p>
</div>
</div>
<div class="section" id="getting-information-about-the-generated-certificates">
<h2><a class="toc-backref" href="#id29">Getting Information about the Generated Certificates</a></h2>
<p>If using LEEC to generate a certificate for a <tt class="docutils literal">baz.foobar.org</tt> host, the following three files shall be obtained from the Let's Encrypt ACME server:</p>
<ul class="simple">
<li><tt class="docutils literal">baz.foobar.org.csr</tt>: the PEM certificate request, sent to the ACME server (~980 bytes)</li>
<li><tt class="docutils literal">baz.foobar.org.key</tt>: the TLS private key regular file, kept on the server (~1675 bytes)</li>
<li><tt class="docutils literal">baz.foobar.org.crt</tt>: the PEM certificate itself of interest (~3450 bytes), to be used by the webserver</li>
</ul>
<p>To get information about this certificate:</p>
<pre class="literal-block">
$ openssl x509 -text -noout -in baz.foobar.org.crt

Certificate:
   Data:
       Version: 3 (0x2)
       Serial Number:
           04:34:17:fd:ee:9b:bd:6b:c2:02:b1:c0:84:62:ed:a6:88:5c
       Signature Algorithm: sha256WithRSAEncryption
       Issuer: C = US, O = Let's Encrypt, CN = R3
       Validity
           Not Before: Dec 27 08:21:38 2020 GMT
           Not After : Mar 27 08:21:38 2021 GMT
       Subject: CN = baz.foobar.org
       Subject Public Key Info:
           Public Key Algorithm: rsaEncryption
               RSA Public-Key: (2048 bit)

              Modulus:
                   [...]
               Exponent: 65537 (0x10001)
       X509v3 extensions:
           X509v3 Key Usage: critical
               Digital Signature, Key Encipherment
           X509v3 Extended Key Usage:
               TLS Web Server Authentication, TLS Web Client Authentication
           X509v3 Basic Constraints: critical
               CA:FALSE
           X509v3 Subject Key Identifier:
               [...]
           X509v3 Authority Key Identifier:
               keyid:C0:CC:03:46:B9:58:20:CC:5C:72:70:F3:E1:2E:CB:20:B6:F5:68:3A

           Authority Information Access:
               OCSP - URI:http://ocsp.stg-int-x1.letsencrypt.org
               CA Issuers - URI:http://cert.stg-int-x1.letsencrypt.org/

           X509v3 Subject Alternative Name:
               DNS:hello.baz.foobar.org.crt, DNS:world.foobar.org.crt, DNS:somesite.foobar.org.crt
           X509v3 Certificate Policies:
               Policy: 2.23.140.1.2.1
               Policy: 1.3.6.1.4.1.44947.1.1.1
                 CPS: http://cps.letsencrypt.org

           CT Precertificate SCTs:
               Signed Certificate Timestamp:
                   Version   : v1 (0x0)
                   Log ID    : [...]
                   Timestamp : Jan  2 09:23:20.310 2021 GMT
                   Extensions: none
                   Signature : ecdsa-with-SHA256
               Signed Certificate Timestamp:
                   Version   : v1 (0x0)
                   Log ID    : [...]
                   Timestamp : Jan  2 09:23:20.320 2021 GMT
                   Extensions: none
                   Signature : ecdsa-with-SHA256
                               [...]
   Signature Algorithm: sha256WithRSAEncryption
   [...]
</pre>
</div>
<div class="section" id="other-files-of-interest">
<h2><a class="toc-backref" href="#id30">Other Files of Interest</a></h2>
<p>A <tt class="docutils literal">*.key</tt> (ex: <tt class="docutils literal"><span class="pre">my-foobar-leec-agent-private.key</span></tt>) file is a (PEM, strong enough) RSA private key generated by LEEC so that its agent can safely authenticate to the ACME servers it is interacting with.</p>
<p><tt class="docutils literal"><span class="pre">lets-encrypt-r3-cross-signed.pem</span></tt> is the (PEM) certificate associated to the <em>Certificate Authority</em> (Let's Encrypt here). It is automatically downloaded by LEEC if not already available.</p>
<p>The <tt class="docutils literal"><span class="pre">dh-params.pem</span></tt> file contains the parameters generated by LEEC in order to allow for safer <em>Ephemeral Diffie-Helman key exchanges</em> that is used to provide Forward Secrecy with TLS (see <a class="reference external" href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">this article</a> for further information). Its generation may take quite some time.</p>
</div>
<div class="section" id="troubleshooting-https-certificate-related-issues">
<h2><a class="toc-backref" href="#id31">Troubleshooting HTTPS Certificate-related Issues</a></h2>
<p>In order to understand why a given host (typically a webserver) does not seem to handle properly certificates, one may experiment with these commands from a client computer:</p>
<pre class="code bash literal-block">
$ curl -vvv -I https://foobar.org
$ wget -v https://foobar.org -O -
$ openssl s_client -connect foobar.org:443
</pre>
<p>From the server itself:</p>
<pre class="code bash literal-block">
$ iptables -nL
$ lsof -i:443
$ netstat -ltpn <span class="p">|</span> grep <span class="s1">':443'</span>
</pre>
<p>Third-party solutions might also be used, like testing your server with <a class="reference external" href="https://www.ssllabs.com/ssltest/analyze.html">SSL Labs</a>; thanks to LEEC, <a class="reference external" href="https://us-web.esperide.org/#usage-recommendations">US-Web can be ranked &quot;grade A&quot;</a> there.</p>
</div>
<div class="section" id="licence">
<h2><a class="toc-backref" href="#id32">Licence</a></h2>
<p>Ceylan-LEEC is distributed under the APACHE 2.0 licence, like the original work that it derives from.</p>
</div>
<div class="section" id="support">
<h2><a class="toc-backref" href="#id33">Support</a></h2>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be sent through the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-LEEC/issues">issues</a>), or directly at the email address mentioned at the beginning of this document.</p>
</div>
<div class="section" id="possible-enhancements">
<h2><a class="toc-backref" href="#id34">Possible Enhancements</a></h2>
<ul class="simple">
<li>re-using ACME accounts: not creating throwaway, anonymous accounts but (possibly) reusing them by registering the ACME client with its email, etc.</li>
<li>supporting certificate revocation</li>
<li>supporting Elliptic Curve cryptography</li>
<li>reintroducing elements brought by the upstream project yet not updated by the current fork: unit testing, standalone testing, hex package, various escripts and yml files involved</li>
<li>besides the slave mode (main use case of interest with LEEC), better integrating/testing the other modes (webroot and standalone)</li>
<li>supporting extra validation challenges, besides <tt class="docutils literal"><span class="pre">http-01</span></tt>, like <tt class="docutils literal"><span class="pre">dns-01</span></tt> (necessary to obtain wildcard certificates, i.e. applying to all subdomains of a given domain) and <tt class="docutils literal"><span class="pre">proof-of-possession-01</span></tt></li>
<li>supporting directly other ACME services besides <tt class="docutils literal">Let's Encrypt</tt> (like <tt class="docutils literal">ZeroSSL</tt>)</li>
</ul>
</div>
<div class="section" id="please-react">
<h2><a class="toc-backref" href="#id35">Please React!</a></h2>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h2><a class="toc-backref" href="#id36">Ending Word</a></h2>
<p>Have fun with Ceylan-LEEC!
(not supposed to involve any memory leak)</p>
<p><span class="raw-html"><center><img src="leec-title.png" id="responsive-image-small"></img></center></span>
</p>
<p><span class="raw-html"><a name="leec_bottom"></a></span></p>
</div>
</div>
</div>
</body>
</html>
